[
  {
    "type": "text",
    "text": "{\n  \"updatedAt\": \"2026-01-16T15:04:47.071Z\",\n  \"createdAt\": \"2025-09-16T12:26:01.719Z\",\n  \"id\": \"nVssYwN1ZQp0nw97\",\n  \"name\": \"Accident Doc - OCR Mistral + AI Extraction\",\n  \"description\": null,\n  \"active\": true,\n  \"isArchived\": false,\n  \"nodes\": [\n    {\n      \"parameters\": {\n        \"jsCode\": \"// ===== COMPETITION ENTRE GEMINI ET OPENAI =====\\nconst allInputs = $input.all();\\nconst requestId = $('Init Tracking').first().json.requestId;\\nconst startTime = $('Init Tracking').first().json.startTime;\\n\\nlet geminiResult = null;\\nlet openaiResult = null;\\n\\n// Récupérer les 2 résultats\\nif (allInputs.length >= 2) {\\n  openaiResult = allInputs[0].json;\\n  geminiResult = allInputs[1].json; \\n} else if (allInputs.length === 1) {\\n  geminiResult = allInputs[0].json;\\n  openaiResult = { error: 'OpenAI failed', output: null };\\n}\\n\\n// ===== FONCTION DE SCORING SIMPLIFIÉE =====\\nfunction scoreResult(result, modelName) {\\n  let score = 0;\\n  \\n  // Vérifier si le résultat existe et est valide\\n  if (!result || !result.output || result.error) {\\n    return { model: modelName, totalScore: 0, result: result };\\n  }\\n  \\n  // Compter les champs critiques remplis\\n  const critical = [\\n    result.output.employeur?.nom_raison_sociale,\\n    result.output.employeur?.siret,\\n    result.output.victime?.nom,\\n    result.output.victime?.prenom,\\n    result.output.accident?.date,\\n    result.output.type_declaration\\n  ];\\n  \\n  const filled = critical.filter(field => field && String(field).trim() !== '' && String(field).trim() !== 'null').length;\\n  score = (filled / critical.length) * 100;\\n  \\n  // Bonus pour structure complète\\n  if (result.output.employeur && Object.keys(result.output.employeur).length > 3) score += 10;\\n  if (result.output.victime && Object.keys(result.output.victime).length > 4) score += 10;\\n  \\n  return {\\n    model: modelName,\\n    totalScore: Math.round(score),\\n    result: result\\n  };\\n}\\n\\n// ===== ÉVALUATION =====\\nconst geminiScore = scoreResult(geminiResult, 'Gemini');\\nconst openaiScore = scoreResult(openaiResult, 'OpenAI');\\n\\n// ===== SÉLECTION DU GAGNANT =====\\nlet winner;\\nif (geminiScore.totalScore > openaiScore.totalScore) {\\n  winner = geminiScore;\\n} else {\\n  winner = openaiScore;\\n}\\n\\n// ===== HYBRIDATION SI SCORES PROCHES =====\\nif (Math.abs(geminiScore.totalScore - openaiScore.totalScore) < 15 && \\n    geminiResult?.output && openaiResult?.output) {\\n  \\n  // Combiner les meilleurs champs\\n  const hybrid = { ...winner.result.output };\\n  \\n  const loser = (winner.model === 'Gemini') ? openaiResult : geminiResult;\\n  \\n  // Récupérer champs manquants du perdant\\n  if ((!hybrid.employeur?.siret || hybrid.employeur?.siret === 'null') && loser.output?.employeur?.siret && loser.output.employeur.siret !== 'null') {\\n    hybrid.employeur.siret = loser.output.employeur.siret;\\n  }\\n  if ((!hybrid.victime?.numero_secu || hybrid.victime?.numero_secu === 'null') && loser.output?.victime?.numero_secu && loser.output.victime.numero_secu !== 'null') {\\n    hybrid.victime.numero_secu = loser.output.victime.numero_secu;\\n  }\\n  \\n  winner.result.output = hybrid;\\n}\\n\\n// ===== VÉRIFICATION FINALE =====\\n// IMPORTANT: Utiliser !! pour convertir en boolean\\nconst hasOutput = !!winner.result?.output;\\nconst hasValidScore = winner.totalScore > 20;\\nconst success = hasValidScore && hasOutput;\\n\\nconsole.log('=== AI COMPETITION ===');\\nconsole.log('Gemini:', geminiScore.totalScore);\\nconsole.log('OpenAI:', openaiScore.totalScore);\\nconsole.log('Winner:', winner.model);\\nconsole.log('Success:', success);\\n\\n// ===== RETOUR COMPATIBLE =====\\nreturn {\\n  output: winner.result?.output || {},\\n  success: success,  // Maintenant c'est un boolean true/false\\n  fallback_mode: !success,\\n  error_message: success ? '' : 'Both AI failed',\\n  elapsed_time: Date.now() - startTime,\\n  requestId: requestId,\\n  winner_model: winner.model\\n};\"\n      },\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [\n        -3072,\n        -224\n      ],\n      \"id\": \"18b5d413-cf35-4c5c-93e8-c7bec7666587\",\n      \"name\": \"AI competition\"\n    },\n    {\n      \"parameters\": {},\n      \"type\": \"n8n-nodes-base.merge\",\n      \"typeVersion\": 3.2,\n      \"position\": [\n        -3312,\n        -224\n      ],\n      \"id\": \"f7d34b23-7416-4f66-bd9c-e71203c7472a\",\n      \"name\": \"Merge\"\n    },\n    {\n      \"parameters\": {\n        \"model\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"gpt-4.1-mini\"\n        },\n        \"options\": {}\n      },\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n      \"typeVersion\": 1.2,\n      \"position\": [\n        -3568,\n        -224\n      ],\n      \"id\": \"70207540-cbd9-499d-ad22-af70a2776670\",\n      \"name\": \"OpenAI Chat Model\",\n      \"credentials\": {\n        \"openAiApi\": {\n          \"id\": \"ReY01TMBOwF2KV4Q\",\n          \"name\": \"OpenAi account\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"text\": \"=Analysez ce document de déclaration d'accident du travail ou maladie professionnelle et extrayez toutes les informations structurées.\\n\\nRETOURNEZ UNIQUEMENT un objet JSON valide, sans aucun texte supplémentaire.\\n\\nDéterminez d'abord le type de déclaration :\\n- AT_normale : Déclaration standard d'accident du travail\\n- AT_interim : Déclaration pour un travailleur intérimaire  \\n- maladie_professionnelle : Déclaration de maladie professionnelle\\n\\nExtrayez ensuite toutes les informations disponibles dans le document.\\n\\nTexte du document :\\n{{ $json.extracted_text }}\",\n        \"schemaType\": \"manual\",\n        \"inputSchema\": \"{\\n  \\\"type\\\": \\\"object\\\",\\n  \\\"properties\\\": {\\n    \\\"type_declaration\\\": {\\n      \\\"type\\\": \\\"string\\\",\\n      \\\"enum\\\": [\\\"AT_normale\\\", \\\"AT_interim\\\", \\\"maladie_professionnelle\\\"],\\n      \\\"description\\\": \\\"Type de déclaration identifié\\\"\\n    },\\n    \\\"employeur\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom_raison_sociale\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_postal\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"telephone\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_risque\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"victime\\\": {\\n      \\\"type\\\": \\\"object\\\", \\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"numero_secu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_naissance\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nationalite\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"profession\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"qualification\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_embauche\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"anciennete_poste\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"type_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"accident\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"date\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"heure\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"activite_victime\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_accident\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"objet_contact\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siege_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"horaire_travail\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"consequences\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"arret_travail\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"deces\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"autres_victimes\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"transport_victime\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"temoin\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"tiers\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"implique\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"assurance\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"interim\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"entreprise_travail_temporaire\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"contrat_numero\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    }\\n  },\\n  \\\"required\\\": [\\\"type_declaration\\\", \\\"employeur\\\", \\\"victime\\\", \\\"accident\\\"]\\n}\",\n        \"options\": {}\n      },\n      \"type\": \"@n8n/n8n-nodes-langchain.informationExtractor\",\n      \"typeVersion\": 1.2,\n      \"position\": [\n        -3632,\n        -112\n      ],\n      \"id\": \"710f2dc2-0a48-44c3-9b28-87d435c8e59a\",\n      \"name\": \"GEMINI extraction\",\n      \"continueOnFail\": true\n    },\n    {\n      \"parameters\": {\n        \"text\": \"=Analysez ce document de déclaration d'accident du travail ou maladie professionnelle et extrayez toutes les informations structurées.\\n\\nRETOURNEZ UNIQUEMENT un objet JSON valide, sans aucun texte supplémentaire.\\n\\nDéterminez d'abord le type de déclaration :\\n- AT_normale : Déclaration standard d'accident du travail\\n- AT_interim : Déclaration pour un travailleur intérimaire  \\n- maladie_professionnelle : Déclaration de maladie professionnelle\\n\\nExtrayez ensuite toutes les informations disponibles dans le document.\\n\\nTexte du document :\\n{{ $json.extracted_text }}\",\n        \"schemaType\": \"manual\",\n        \"inputSchema\": \"{\\n  \\\"type\\\": \\\"object\\\",\\n  \\\"properties\\\": {\\n    \\\"type_declaration\\\": {\\n      \\\"type\\\": \\\"string\\\",\\n      \\\"enum\\\": [\\\"AT_normale\\\", \\\"AT_interim\\\", \\\"maladie_professionnelle\\\"],\\n      \\\"description\\\": \\\"Type de déclaration identifié\\\"\\n    },\\n    \\\"employeur\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom_raison_sociale\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_postal\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"telephone\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_risque\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"victime\\\": {\\n      \\\"type\\\": \\\"object\\\", \\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"numero_secu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_naissance\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nationalite\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"profession\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"qualification\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_embauche\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"anciennete_poste\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"type_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"accident\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"date\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"heure\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"activite_victime\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_accident\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"objet_contact\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siege_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"horaire_travail\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"consequences\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"arret_travail\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"deces\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"autres_victimes\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"transport_victime\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"temoin\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"tiers\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"implique\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"assurance\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"interim\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"entreprise_travail_temporaire\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"contrat_numero\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    }\\n  },\\n  \\\"required\\\": [\\\"type_declaration\\\", \\\"employeur\\\", \\\"victime\\\", \\\"accident\\\"]\\n}\",\n        \"options\": {}\n      },\n      \"type\": \"@n8n/n8n-nodes-langchain.informationExtractor\",\n      \"typeVersion\": 1.2,\n      \"position\": [\n        -3632,\n        -384\n      ],\n      \"id\": \"e12304e8-4509-454f-86bc-5df04ccd495b\",\n      \"name\": \"OPENAI Extraction\",\n      \"continueOnFail\": true\n    },\n    {\n      \"parameters\": {\n        \"respondWith\": \"json\",\n        \"responseBody\": \"={{ $json }}\",\n        \"options\": {\n          \"responseHeaders\": {\n            \"entries\": [\n              {\n                \"name\": \"Access-Control-Allow-Origin\",\n                \"value\": \"https://accidentdoc-web.vercel.app\"\n              },\n              {\n                \"name\": \"Access-Control-Allow-Methods\",\n                \"value\": \"POST, OPTIONS\"\n              },\n              {\n                \"name\": \"Access-Control-Allow-Headers\",\n                \"value\": \"Content-Type, X-Requested-With, Authorization\"\n              },\n              {\n                \"name\": \"Access-Control-Max-Age\",\n                \"value\": \"600\"\n              },\n              {\n                \"name\": \"Content-Type\",\n                \"value\": \"application/json\"\n              }\n            ]\n          }\n        }\n      },\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"typeVersion\": 1.1,\n      \"position\": [\n        -1248,\n        -32\n      ],\n      \"id\": \"a4cf3e7b-7f5c-4f51-a5ce-e7080f6ca106\",\n      \"name\": \"Respond to Webhook\"\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// CONSTRUCTION DE LA REPONSE FINALE FRONT-READY\\nconst input = $input.first().json;\\nconst responseForWebsite = input.responseForWebsite;\\nconst requestId = input.requestId;\\n\\n// URL de votre site - MISE À JOUR VERCEL\\nconst SITE_URL = 'https://accidentdoc-web.vercel.app';\\n\\n// Construction de la réponse finale front-ready\\nconst finalResponse = {\\n  ok: responseForWebsite.success !== false,\\n  requestId: requestId,\\n  next: responseForWebsite.success !== false ? `${SITE_URL}/validation?rid=${requestId}` : `${SITE_URL}/upload?error=invalid_document`,\\n  payload: responseForWebsite\\n};\\n\\nconsole.log('=== FINAL RESPONSE ===');\\nconsole.log('Request ID:', requestId);\\nconsole.log('Success:', finalResponse.ok);\\nconsole.log('Fallback mode:', responseForWebsite.fallback_mode || false);\\nconsole.log('Document Type:', responseForWebsite.documentType);\\nconsole.log('Session ID:', responseForWebsite.sessionId);\\nif (responseForWebsite.completionStats) {\\n  console.log('Completion Rate:', responseForWebsite.completionStats.completionRate + '%');\\n}\\nif (responseForWebsite.errorDetails) {\\n  console.log('ERROR:', responseForWebsite.errorDetails.message);\\n}\\n\\nreturn finalResponse;\"\n      },\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [\n        -1440,\n        -32\n      ],\n      \"id\": \"2ffaa0d0-9460-4788-952b-108d971fe88a\",\n      \"name\": \"Build Front Response\"\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// PREPARATION DES DONNEES POUR VALIDATION UTILISATEUR (MODE NORMAL)\\nconst finalResult = $input.first().json.resultat_final;\\nconst extractedData = finalResult.declaration;\\nconst sessionId = 'validation_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);\\nconst requestId = $('Init Tracking').first().json.requestId;\\n\\n// Analyser le type de document pour adapter les champs\\nconst docType = extractedData.type;\\nconst isInterim = docType === 'AT_INTERIM';\\nconst isMaladiePro = docType === 'MALADIE_PROFESSIONNELLE';\\n\\n// STRUCTURE DES CHAMPS A VALIDER selon le type\\nlet fieldsToValidate = [];\\n\\n// Champs communs\\nconst commonFields = [\\n  { section: 'employeur', field: 'nom_raison_sociale', label: 'Raison sociale employeur', required: true },\\n  { section: 'employeur', field: 'siret', label: 'SIRET employeur', required: true },\\n  { section: 'employeur', field: 'adresse', label: 'Adresse employeur', required: true },\\n  { section: 'victime', field: 'nom', label: 'Nom de la victime', required: true },\\n  { section: 'victime', field: 'prenom', label: 'Prénom de la victime', required: true },\\n  { section: 'victime', field: 'numero_secu', label: 'Numéro sécurité sociale', required: true },\\n  { section: 'victime', field: 'date_naissance', label: 'Date de naissance', required: true },\\n  { section: 'victime', field: 'adresse', label: 'Adresse de la victime', required: true },\\n  { section: 'victime', field: 'profession', label: 'Profession', required: true }\\n];\\n\\n// Champs spécifiques selon le type\\nif (isMaladiePro) {\\n  fieldsToValidate = commonFields.concat([\\n    { section: 'maladie', field: 'date', label: 'Date des premiers symptômes', required: true },\\n    { section: 'maladie', field: 'lieu', label: 'Lieu d\\\\'exposition', required: false },\\n    { section: 'maladie', field: 'activite_victime', label: 'Activité exposante', required: false }\\n  ]);\\n} else {\\n  fieldsToValidate = commonFields.concat([\\n    { section: 'accident', field: 'date', label: 'Date de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'heure', label: 'Heure de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'lieu', label: 'Lieu de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'activite_victime', label: 'Activité au moment de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'nature_accident', label: 'Nature de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'siege_lesions', label: 'Siège des lésions', required: false },\\n    { section: 'accident', field: 'nature_lesions', label: 'Nature des lésions', required: false }\\n  ]);\\n  \\n  if (isInterim) {\\n    fieldsToValidate = fieldsToValidate.concat([\\n      { section: 'interim', field: 'entreprise_travail_temporaire', label: 'Entreprise de travail temporaire', required: true },\\n      { section: 'interim', field: 'siret_agence', label: 'SIRET de l\\\\'agence', required: true }\\n    ]);\\n  }\\n}\\n\\n// EXTRACTION DES VALEURS ACTUELLES\\nconst currentValues = {};\\nfor (let i = 0; i < fieldsToValidate.length; i++) {\\n  const field = fieldsToValidate[i];\\n  const sectionData = extractedData[field.section] || {};\\n  const value = sectionData[field.field] || null;\\n  \\n  const fieldKey = field.section + '.' + field.field;\\n  currentValues[fieldKey] = {\\n    label: field.label,\\n    value: value,\\n    section: field.section,\\n    field: field.field,\\n    required: field.required,\\n    isEmpty: !value || String(value).trim() === '',\\n    needsValidation: !value || String(value).trim() === '' || field.required\\n  };\\n}\\n\\n// CALCUL DES STATISTIQUES\\nconst totalFields = fieldsToValidate.length;\\nlet filledFields = 0;\\nlet requiredFields = 0;\\nlet filledRequiredFields = 0;\\n\\nfor (const fieldKey in currentValues) {\\n  const field = currentValues[fieldKey];\\n  if (!field.isEmpty) filledFields++;\\n  if (field.required) {\\n    requiredFields++;\\n    if (!field.isEmpty) filledRequiredFields++;\\n  }\\n}\\n\\nconst completionRate = Math.round((filledFields / totalFields) * 100);\\nconst requiredCompletionRate = Math.round((filledRequiredFields / requiredFields) * 100);\\n\\n// Questions contextuelles par défaut\\nconst contextualQuestions = [\\n  {\\n    id: 'commentaire_libre',\\n    question: 'Souhaitez-vous ajouter un commentaire libre avant la génération de la lettre ?',\\n    type: 'textarea',\\n    context: 'Commentaire final',\\n    category: 'cloture'\\n  }\\n];\\n\\n// PREPARATION DE LA REPONSE COMPLETE POUR LE SITE WEB\\nconst responseForWebsite = {\\n  success: true,\\n  fallback_mode: false,\\n  sessionId: sessionId,\\n  documentType: docType,\\n  \\n  extractedData: {\\n    employeur: extractedData.employeur || {},\\n    victime: extractedData.victime || {},\\n    accident: isMaladiePro ? null : (extractedData.accident || {}),\\n    maladie: isMaladiePro ? (extractedData.maladie || {}) : null,\\n    interim: isInterim ? (extractedData.interim || {}) : null,\\n    temoin: extractedData.temoin || {},\\n    tiers: extractedData.tiers || {}\\n  },\\n  \\n  validationFields: currentValues,\\n  contextualQuestions: contextualQuestions,\\n  \\n  completionStats: {\\n    totalFields: totalFields,\\n    filledFields: filledFields,\\n    completionRate: completionRate,\\n    requiredFields: requiredFields,\\n    filledRequiredFields: filledRequiredFields,\\n    requiredCompletionRate: requiredCompletionRate\\n  },\\n  \\n  nextStep: 'user_validation',\\n  instructions: {\\n    message: 'Vérifiez et complétez les informations extraites automatiquement.',\\n    validationEndpoint: '/webhook/validate-data',\\n    expectedFields: fieldsToValidate.map(f => f.section + '.' + f.field)\\n  },\\n  \\n  metadata: {\\n    extractionSource: 'mistral_ocr',\\n    aiModel: finalResult.metadata.ai_model || 'gemini-2.0-flash',\\n    extractionTimestamp: finalResult.timestamp,\\n    validationPreparedAt: new Date().toISOString()\\n  }\\n};\\n\\nreturn {\\n  responseForWebsite: responseForWebsite,\\n  requestId: requestId\\n};\"\n      },\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [\n        -1664,\n        -144\n      ],\n      \"id\": \"27bfe0bf-1337-48ec-ad85-d0ad46dc9357\",\n      \"name\": \"Prepare User Validation\"\n    },\n    {\n      \"parameters\": {\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"final-result\",\n              \"name\": \"resultat_final\",\n              \"type\": \"object\",\n              \"value\": \"={{ {\\n  success: true,\\n  timestamp: new Date().toISOString(),\\n  declaration: $json.declaration_formatee,\\n  metadata: {\\n    source: 'mistral_ocr',\\n    ai_model: 'gemini-2.0-flash',\\n    extraction_time: new Date().toISOString()\\n  }\\n} }}\"\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.set\",\n      \"typeVersion\": 3.4,\n      \"position\": [\n        -1824,\n        -144\n      ],\n      \"id\": \"baab3f06-7bf8-4eb5-8ac1-aa87362ee8b4\",\n      \"name\": \"Final Result\"\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// GESTION ERREUR - DOCUMENT NON CONFORME\\nconst requestId = $('Init Tracking').first().json.requestId;\\nconst sessionId = 'invalid_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);\\n\\n// Récupérer le type détecté (s'il existe)\\nconst detectedType = $input.first().json.output?.type_declaration || 'UNKNOWN';\\n\\n// Message d'erreur détaillé\\nconst errorMessage = `Le document uploadé ne correspond pas à un type de déclaration attendu.\\\\n\\\\nType détecté: ${detectedType}\\\\n\\\\nTypes acceptés:\\\\n- AT_normale (Déclaration d'accident du travail standard)\\\\n- AT_interim (Déclaration d'accident du travail pour intérimaire)\\\\n- maladie_professionnelle (Déclaration de maladie professionnelle)\\\\n\\\\nVeuillez vérifier que vous avez uploadé le bon document.`;\\n\\nconst invalidDocResponse = {\\n  success: false,\\n  error_type: 'INVALID_DOCUMENT_TYPE',\\n  fallback_mode: false,\\n  sessionId: sessionId,\\n  documentType: detectedType,\\n  \\n  errorDetails: {\\n    code: 'DOC_TYPE_MISMATCH',\\n    message: errorMessage,\\n    detectedType: detectedType,\\n    expectedTypes: ['AT_normale', 'AT_interim', 'maladie_professionnelle'],\\n    suggestion: 'Veuillez uploader une déclaration d\\\\'accident du travail (intérim ou normale) ou une déclaration de maladie professionnelle.'\\n  },\\n  \\n  nextStep: 'upload_correct_document',\\n  instructions: {\\n    message: 'Document non conforme. Veuillez uploader un document de type attendu.',\\n    uploadEndpoint: '/webhook/upload',\\n    acceptedDocumentTypes: [\\n      'Déclaration d\\\\'accident du travail (CERFA 14463)',\\n      'Déclaration d\\\\'accident du travail intérim (CERFA 14463)',\\n      'Déclaration de maladie professionnelle (CERFA 60-3950)'\\n    ]\\n  },\\n  \\n  metadata: {\\n    extractionSource: 'mistral_ocr',\\n    aiModel: 'ai_detection',\\n    extractionTimestamp: new Date().toISOString(),\\n    error_reason: 'Document type not matching expected types',\\n    elapsed_time: Date.now() - $('Init Tracking').first().json.startTime\\n  }\\n};\\n\\nreturn {\\n  responseForWebsite: invalidDocResponse,\\n  requestId: requestId\\n};\"\n      },\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [\n        -2288,\n        176\n      ],\n      \"id\": \"56420ed5-3029-4cc4-80df-c120d47e5d0e\",\n      \"name\": \"Build Invalid Document Error\"\n    },\n    {\n      \"parameters\": {\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"format-mp\",\n              \"name\": \"declaration_formatee\",\n              \"type\": \"object\",\n              \"value\": \"={{ {\\n  type: 'MALADIE_PROFESSIONNELLE',\\n  numero_declaration: 'MP' + new Date().getTime(),\\n  date_extraction: new Date().toISOString(),\\n  employeur: $json.output.employeur,\\n  victime: $json.output.victime,\\n  maladie: $json.output.accident,\\n  temoin: $json.output.temoin,\\n  statut: 'EXTRACTED'\\n} }}\"\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.set\",\n      \"typeVersion\": 3.4,\n      \"position\": [\n        -2080,\n        -144\n      ],\n      \"id\": \"28b24ac1-fa66-4131-b4e3-e0159c8e20b8\",\n      \"name\": \"Format Maladie Pro\"\n    },\n    {\n      \"parameters\": {\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"format-at-interim\",\n              \"name\": \"declaration_formatee\",\n              \"type\": \"object\",\n              \"value\": \"={{ {\\n  type: 'AT_INTERIM',\\n  numero_declaration: 'ATI' + new Date().getTime(),\\n  date_extraction: new Date().toISOString(),\\n  employeur: $json.output.employeur,\\n  victime: $json.output.victime,\\n  accident: $json.output.accident,\\n  interim: $json.output.interim,\\n  temoin: $json.output.temoin,\\n  tiers: $json.output.tiers,\\n  statut: 'EXTRACTED'\\n} }}\"\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.set\",\n      \"typeVersion\": 3.4,\n      \"position\": [\n        -2080,\n        -496\n      ],\n      \"id\": \"7ebb36d7-57d2-40b5-98e9-f25c798fd55d\",\n      \"name\": \"Format AT Intérim\"\n    },\n    {\n      \"parameters\": {\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"format-at-normale\",\n              \"name\": \"declaration_formatee\",\n              \"type\": \"object\",\n              \"value\": \"={{ {\\n  type: 'AT_NORMALE',\\n  numero_declaration: 'AT' + new Date().getTime(),\\n  date_extraction: new Date().toISOString(),\\n  employeur: $json.output.employeur,\\n  victime: $json.output.victime,\\n  accident: $json.output.accident,\\n  temoin: $json.output.temoin,\\n  tiers: $json.output.tiers,\\n  statut: 'EXTRACTED'\\n} }}\"\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.set\",\n      \"typeVersion\": 3.4,\n      \"position\": [\n        -2080,\n        -320\n      ],\n      \"id\": \"188bdc68-19ef-463a-bd1d-fabb6faacf96\",\n      \"name\": \"Format AT Normale\"\n    },\n    {\n      \"parameters\": {\n        \"rules\": {\n          \"values\": [\n            {\n              \"conditions\": {\n                \"options\": {\n                  \"caseSensitive\": true,\n                  \"leftValue\": \"\",\n                  \"typeValidation\": \"strict\",\n                  \"version\": 2\n                },\n                \"conditions\": [\n                  {\n                    \"leftValue\": \"={{ $json.output.type_declaration }}\",\n                    \"rightValue\": \"AT_interim\",\n                    \"operator\": {\n                      \"type\": \"string\",\n                      \"operation\": \"equals\"\n                    },\n                    \"id\": \"838ae07e-b6c5-4158-a1bb-2f6608f16985\"\n                  }\n                ],\n                \"combinator\": \"and\"\n              }\n            },\n            {\n              \"conditions\": {\n                \"options\": {\n                  \"caseSensitive\": true,\n                  \"leftValue\": \"\",\n                  \"typeValidation\": \"strict\",\n                  \"version\": 2\n                },\n                \"conditions\": [\n                  {\n                    \"id\": \"c1463ff9-09fe-4a2f-9223-25b516ebbf2b\",\n                    \"leftValue\": \"={{ $json.output.type_declaration }}\",\n                    \"rightValue\": \"AT_normale\",\n                    \"operator\": {\n                      \"type\": \"string\",\n                      \"operation\": \"equals\",\n                      \"name\": \"filter.operator.equals\"\n                    }\n                  }\n                ],\n                \"combinator\": \"and\"\n              }\n            },\n            {\n              \"conditions\": {\n                \"options\": {\n                  \"caseSensitive\": true,\n                  \"leftValue\": \"\",\n                  \"typeValidation\": \"strict\",\n                  \"version\": 2\n                },\n                \"conditions\": [\n                  {\n                    \"id\": \"bd1d2084-5ffc-444c-a108-87329fbf4fb9\",\n                    \"leftValue\": \"={{ $json.output.type_declaration }}\",\n                    \"rightValue\": \"maladie_professionnelle\",\n                    \"operator\": {\n                      \"type\": \"string\",\n                      \"operation\": \"equals\",\n                      \"name\": \"filter.operator.equals\"\n                    }\n                  }\n                ],\n                \"combinator\": \"and\"\n              }\n            }\n          ]\n        },\n        \"options\": {\n          \"fallbackOutput\": \"extra\"\n        }\n      },\n      \"type\": \"n8n-nodes-base.switch\",\n      \"typeVersion\": 3.2,\n      \"position\": [\n        -2656,\n        -256\n      ],\n      \"id\": \"c51ab7e3-c335-4107-b4c6-effd9f1a13e0\",\n      \"name\": \"Route by Type\"\n    },\n    {\n      \"parameters\": {\n        \"modelName\": \"models/gemini-2.0-flash-exp\",\n        \"options\": {}\n      },\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatGoogleGemini\",\n      \"typeVersion\": 1,\n      \"position\": [\n        -3552,\n        64\n      ],\n      \"id\": \"4523eb8c-6faf-41cc-95bf-fec1f911eb78\",\n      \"name\": \"Gemini 2.0 Flash\",\n      \"credentials\": {\n        \"googlePalmApi\": {\n          \"id\": \"uPkthesEOgAOyuUB\",\n          \"name\": \"Google Gemini(PaLM) Api account\"\n        }\n      }\n    },\n    {\n      \"parameters\": {\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"text_content\",\n              \"name\": \"extracted_text\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.pages?.map(page => page.markdown).join('\\\\n\\\\n') || '' }}\"\n            },\n            {\n              \"id\": \"ocr_success\",\n              \"name\": \"ocr_success\",\n              \"type\": \"boolean\",\n              \"value\": \"={{ $json.pages && $json.pages.length > 0 }}\"\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"type\": \"n8n-nodes-base.set\",\n      \"typeVersion\": 3.4,\n      \"position\": [\n        -4032,\n        128\n      ],\n      \"id\": \"2b83eef2-de70-408a-aae8-940b9ae3f0a9\",\n      \"name\": \"Format Text\"\n    },\n    {\n      \"parameters\": {\n        \"method\": \"POST\",\n        \"url\": \"https://api.mistral.ai/v1/ocr\",\n        \"authentication\": \"genericCredentialType\",\n        \"genericAuthType\": \"httpHeaderAuth\",\n        \"sendBody\": true,\n        \"specifyBody\": \"json\",\n        \"jsonBody\": \"={{ JSON.stringify({\\n  \\\"model\\\": \\\"mistral-ocr-latest\\\",\\n  \\\"document\\\": {\\n    \\\"type\\\": \\\"document_url\\\",\\n    \\\"document_url\\\": $json.url\\n  },\\n  \\\"include_image_base64\\\": false\\n}) }}\",\n        \"options\": {\n          \"timeout\": 25000\n        }\n      },\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.2,\n      \"position\": [\n        -4192,\n        128\n      ],\n      \"id\": \"1893012c-2506-4ec0-83b3-879a2c86400a\",\n      \"name\": \"Extract OCR\",\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"ky1L3tKefy3aLQey\",\n          \"name\": \"Mistral OCR\"\n        }\n      },\n      \"continueOnFail\": true\n    },\n    {\n      \"parameters\": {\n        \"url\": \"=https://api.mistral.ai/v1/files/{{ $json.id }}/url\",\n        \"authentication\": \"genericCredentialType\",\n        \"genericAuthType\": \"httpHeaderAuth\",\n        \"sendQuery\": true,\n        \"queryParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"expiry\",\n              \"value\": \"24\"\n            }\n          ]\n        },\n        \"options\": {\n          \"timeout\": 15000\n        }\n      },\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.2,\n      \"position\": [\n        -4400,\n        128\n      ],\n      \"id\": \"09d58179-eccf-4efb-a18d-5a67fabaebae\",\n      \"name\": \"Get Signed URL\",\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"ky1L3tKefy3aLQey\",\n          \"name\": \"Mistral OCR\"\n        }\n      },\n      \"continueOnFail\": true\n    },\n    {\n      \"parameters\": {\n        \"respondWith\": \"noData\",\n        \"options\": {\n          \"responseHeaders\": {\n            \"entries\": [\n              {\n                \"name\": \"Access-Control-Allow-Origin\",\n                \"value\": \"https://accidentdoc-web.vercel.app\"\n              },\n              {\n                \"name\": \"Access-Control-Allow-Methods\",\n                \"value\": \"POST, OPTIONS\"\n              },\n              {\n                \"name\": \"Access-Control-Allow-Headers\",\n                \"value\": \"Content-Type, X-Requested-With, Authorization\"\n              },\n              {\n                \"name\": \"Access-Control-Max-Age\",\n                \"value\": \"600\"\n              }\n            ]\n          }\n        }\n      },\n      \"type\": \"n8n-nodes-base.respondToWebhook\",\n      \"typeVersion\": 1.1,\n      \"position\": [\n        -4736,\n        448\n      ],\n      \"id\": \"474115bd-f1fe-4bc4-b666-d9e4b384d2cb\",\n      \"name\": \"Respond OPTIONS\"\n    },\n    {\n      \"parameters\": {\n        \"httpMethod\": \"OPTIONS\",\n        \"path\": \"upload\",\n        \"responseMode\": \"responseNode\",\n        \"options\": {\n          \"rawBody\": false\n        }\n      },\n      \"type\": \"n8n-nodes-base.webhook\",\n      \"typeVersion\": 2,\n      \"position\": [\n        -4944,\n        448\n      ],\n      \"id\": \"51f3ad1c-bb9f-4220-9de4-40b82348d3d3\",\n      \"name\": \"OPTIONS Preflight\",\n      \"webhookId\": \"options-preflight\"\n    },\n    {\n      \"parameters\": {\n        \"httpMethod\": \"POST\",\n        \"path\": \"upload\",\n        \"responseMode\": \"responseNode\",\n        \"options\": {\n          \"rawBody\": false\n        }\n      },\n      \"type\": \"n8n-nodes-base.webhook\",\n      \"typeVersion\": 2,\n      \"position\": [\n        -4992,\n        288\n      ],\n      \"id\": \"fb60b218-a2b7-4746-8982-99c1a89ea9cd\",\n      \"name\": \"Upload Webhook\",\n      \"webhookId\": \"upload-webhook\"\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Init tracking - CONSERVE LES DONNEES BINAIRES\\nconst items = $input.all();\\n\\nfor (const item of items) {\\n  item.json.requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\\n  item.json.startTime = Date.now();\\n}\\n\\nreturn items;\"\n      },\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [\n        -4784,\n        288\n      ],\n      \"id\": \"559ede3b-7977-45a1-8328-058db2c5d41d\",\n      \"name\": \"Init Tracking\"\n    },\n    {\n      \"parameters\": {\n        \"method\": \"POST\",\n        \"url\": \"https://api.mistral.ai/v1/files\",\n        \"authentication\": \"genericCredentialType\",\n        \"genericAuthType\": \"httpHeaderAuth\",\n        \"sendBody\": true,\n        \"contentType\": \"multipart-form-data\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"purpose\",\n              \"value\": \"ocr\"\n            },\n            {\n              \"parameterType\": \"formBinaryData\",\n              \"name\": \"file\",\n              \"inputDataFieldName\": \"file\"\n            }\n          ]\n        },\n        \"options\": {\n          \"timeout\": 30000\n        }\n      },\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"typeVersion\": 4.3,\n      \"position\": [\n        -4592,\n        288\n      ],\n      \"id\": \"9af853c8-ab5b-4304-946e-e50211283927\",\n      \"name\": \"Upload to Mistral\",\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"ky1L3tKefy3aLQey\",\n          \"name\": \"Mistral OCR\"\n        }\n      },\n      \"onError\": \"continueRegularOutput\"\n    }\n  ],\n  \"connections\": {\n    \"Merge\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"AI competition\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"GEMINI extraction\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"OPENAI Extraction\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"OpenAI Chat Model\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"OPENAI Extraction\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"AI competition\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Route by Type\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Build Front Response\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Respond to Webhook\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Prepare User Validation\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Build Front Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Final Result\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Prepare User Validation\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Build Invalid Document Error\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Build Front Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Format Maladie Pro\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Final Result\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Format AT Intérim\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Final Result\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Format AT Normale\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Final Result\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Route by Type\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Format AT Intérim\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Format AT Normale\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Format Maladie Pro\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Build Invalid Document Error\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Gemini 2.0 Flash\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"GEMINI extraction\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Format Text\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"GEMINI extraction\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"OPENAI Extraction\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract OCR\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Format Text\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Signed URL\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract OCR\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"OPTIONS Preflight\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Respond OPTIONS\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Upload Webhook\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Init Tracking\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Init Tracking\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Upload to Mistral\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Upload to Mistral\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Signed URL\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  },\n  \"settings\": {\n    \"executionOrder\": \"v1\",\n    \"availableInMCP\": true\n  },\n  \"staticData\": null,\n  \"meta\": {\n    \"templateCredsSetupCompleted\": true\n  },\n  \"pinData\": {},\n  \"versionId\": \"20cb7d69-f323-4087-b191-d90b06dee301\",\n  \"activeVersionId\": \"20cb7d69-f323-4087-b191-d90b06dee301\",\n  \"versionCounter\": 66,\n  \"triggerCount\": 2,\n  \"shared\": [\n    {\n      \"updatedAt\": \"2025-09-16T12:26:01.739Z\",\n      \"createdAt\": \"2025-09-16T12:26:01.739Z\",\n      \"role\": \"workflow:owner\",\n      \"workflowId\": \"nVssYwN1ZQp0nw97\",\n      \"projectId\": \"iMnyvYJwBNy1xQjT\",\n      \"project\": {\n        \"updatedAt\": \"2025-09-13T09:32:20.177Z\",\n        \"createdAt\": \"2025-09-13T09:30:13.483Z\",\n        \"id\": \"iMnyvYJwBNy1xQjT\",\n        \"name\": \"franck franck.lapuyade@atexya.com <franck.lapuyade@atexya.com>\",\n        \"type\": \"personal\",\n        \"icon\": null,\n        \"description\": null,\n        \"creatorId\": \"d0bd9d76-afaf-4157-8f6c-638ab4b0b11f\",\n        \"projectRelations\": [\n          {\n            \"updatedAt\": \"2025-09-13T09:30:13.483Z\",\n            \"createdAt\": \"2025-09-13T09:30:13.483Z\",\n            \"userId\": \"d0bd9d76-afaf-4157-8f6c-638ab4b0b11f\",\n            \"projectId\": \"iMnyvYJwBNy1xQjT\",\n            \"user\": {\n              \"updatedAt\": \"2026-01-21T07:43:41.000Z\",\n              \"createdAt\": \"2025-09-13T09:30:12.886Z\",\n              \"id\": \"d0bd9d76-afaf-4157-8f6c-638ab4b0b11f\",\n              \"email\": \"franck.lapuyade@atexya.com\",\n              \"firstName\": \"franck\",\n              \"lastName\": \"franck.lapuyade@atexya.com\",\n              \"personalizationAnswers\": {\n                \"version\": \"v4\",\n                \"personalization_survey_submitted_at\": \"2025-09-13T09:32:54.093Z\",\n                \"personalization_survey_n8n_version\": \"1.109.2\",\n                \"companyIndustryExtended\": [\n                  \"finance-insurance-industry\"\n                ],\n                \"companySize\": \"<20\",\n                \"companyType\": \"other\",\n                \"role\": \"business-owner\",\n                \"reportedSource\": \"youtube\"\n              },\n              \"settings\": {\n                \"userActivated\": true,\n                \"easyAIWorkflowOnboarded\": true,\n                \"firstSuccessfulWorkflowId\": \"1owZgpOxQSj1IwcD\",\n                \"userActivatedAt\": 1757841144569,\n                \"npsSurvey\": {\n                  \"responded\": true,\n                  \"lastShownAt\": 1758108796397\n                }\n              },\n              \"disabled\": false,\n              \"mfaEnabled\": false,\n              \"lastActiveAt\": \"2026-01-20\",\n              \"isPending\": false\n            }\n          }\n        ]\n      }\n    }\n  ],\n  \"tags\": [\n    {\n      \"updatedAt\": \"2025-09-29T08:09:28.439Z\",\n      \"createdAt\": \"2025-09-29T08:09:28.439Z\",\n      \"id\": \"58WPsdpUZloAjtFt\",\n      \"name\": \"Accidoc\"\n    }\n  ],\n  \"activeVersion\": {\n    \"updatedAt\": \"2026-01-16T15:04:49.000Z\",\n    \"createdAt\": \"2026-01-16T15:04:47.073Z\",\n    \"versionId\": \"20cb7d69-f323-4087-b191-d90b06dee301\",\n    \"workflowId\": \"nVssYwN1ZQp0nw97\",\n    \"nodes\": [\n      {\n        \"parameters\": {\n          \"jsCode\": \"// ===== COMPETITION ENTRE GEMINI ET OPENAI =====\\nconst allInputs = $input.all();\\nconst requestId = $('Init Tracking').first().json.requestId;\\nconst startTime = $('Init Tracking').first().json.startTime;\\n\\nlet geminiResult = null;\\nlet openaiResult = null;\\n\\n// Récupérer les 2 résultats\\nif (allInputs.length >= 2) {\\n  openaiResult = allInputs[0].json;\\n  geminiResult = allInputs[1].json; \\n} else if (allInputs.length === 1) {\\n  geminiResult = allInputs[0].json;\\n  openaiResult = { error: 'OpenAI failed', output: null };\\n}\\n\\n// ===== FONCTION DE SCORING SIMPLIFIÉE =====\\nfunction scoreResult(result, modelName) {\\n  let score = 0;\\n  \\n  // Vérifier si le résultat existe et est valide\\n  if (!result || !result.output || result.error) {\\n    return { model: modelName, totalScore: 0, result: result };\\n  }\\n  \\n  // Compter les champs critiques remplis\\n  const critical = [\\n    result.output.employeur?.nom_raison_sociale,\\n    result.output.employeur?.siret,\\n    result.output.victime?.nom,\\n    result.output.victime?.prenom,\\n    result.output.accident?.date,\\n    result.output.type_declaration\\n  ];\\n  \\n  const filled = critical.filter(field => field && String(field).trim() !== '' && String(field).trim() !== 'null').length;\\n  score = (filled / critical.length) * 100;\\n  \\n  // Bonus pour structure complète\\n  if (result.output.employeur && Object.keys(result.output.employeur).length > 3) score += 10;\\n  if (result.output.victime && Object.keys(result.output.victime).length > 4) score += 10;\\n  \\n  return {\\n    model: modelName,\\n    totalScore: Math.round(score),\\n    result: result\\n  };\\n}\\n\\n// ===== ÉVALUATION =====\\nconst geminiScore = scoreResult(geminiResult, 'Gemini');\\nconst openaiScore = scoreResult(openaiResult, 'OpenAI');\\n\\n// ===== SÉLECTION DU GAGNANT =====\\nlet winner;\\nif (geminiScore.totalScore > openaiScore.totalScore) {\\n  winner = geminiScore;\\n} else {\\n  winner = openaiScore;\\n}\\n\\n// ===== HYBRIDATION SI SCORES PROCHES =====\\nif (Math.abs(geminiScore.totalScore - openaiScore.totalScore) < 15 && \\n    geminiResult?.output && openaiResult?.output) {\\n  \\n  // Combiner les meilleurs champs\\n  const hybrid = { ...winner.result.output };\\n  \\n  const loser = (winner.model === 'Gemini') ? openaiResult : geminiResult;\\n  \\n  // Récupérer champs manquants du perdant\\n  if ((!hybrid.employeur?.siret || hybrid.employeur?.siret === 'null') && loser.output?.employeur?.siret && loser.output.employeur.siret !== 'null') {\\n    hybrid.employeur.siret = loser.output.employeur.siret;\\n  }\\n  if ((!hybrid.victime?.numero_secu || hybrid.victime?.numero_secu === 'null') && loser.output?.victime?.numero_secu && loser.output.victime.numero_secu !== 'null') {\\n    hybrid.victime.numero_secu = loser.output.victime.numero_secu;\\n  }\\n  \\n  winner.result.output = hybrid;\\n}\\n\\n// ===== VÉRIFICATION FINALE =====\\n// IMPORTANT: Utiliser !! pour convertir en boolean\\nconst hasOutput = !!winner.result?.output;\\nconst hasValidScore = winner.totalScore > 20;\\nconst success = hasValidScore && hasOutput;\\n\\nconsole.log('=== AI COMPETITION ===');\\nconsole.log('Gemini:', geminiScore.totalScore);\\nconsole.log('OpenAI:', openaiScore.totalScore);\\nconsole.log('Winner:', winner.model);\\nconsole.log('Success:', success);\\n\\n// ===== RETOUR COMPATIBLE =====\\nreturn {\\n  output: winner.result?.output || {},\\n  success: success,  // Maintenant c'est un boolean true/false\\n  fallback_mode: !success,\\n  error_message: success ? '' : 'Both AI failed',\\n  elapsed_time: Date.now() - startTime,\\n  requestId: requestId,\\n  winner_model: winner.model\\n};\"\n        },\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          -3072,\n          -224\n        ],\n        \"id\": \"18b5d413-cf35-4c5c-93e8-c7bec7666587\",\n        \"name\": \"AI competition\"\n      },\n      {\n        \"parameters\": {},\n        \"type\": \"n8n-nodes-base.merge\",\n        \"typeVersion\": 3.2,\n        \"position\": [\n          -3312,\n          -224\n        ],\n        \"id\": \"f7d34b23-7416-4f66-bd9c-e71203c7472a\",\n        \"name\": \"Merge\"\n      },\n      {\n        \"parameters\": {\n          \"model\": {\n            \"__rl\": true,\n            \"mode\": \"list\",\n            \"value\": \"gpt-4.1-mini\"\n          },\n          \"options\": {}\n        },\n        \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n        \"typeVersion\": 1.2,\n        \"position\": [\n          -3568,\n          -224\n        ],\n        \"id\": \"70207540-cbd9-499d-ad22-af70a2776670\",\n        \"name\": \"OpenAI Chat Model\",\n        \"credentials\": {\n          \"openAiApi\": {\n            \"id\": \"ReY01TMBOwF2KV4Q\",\n            \"name\": \"OpenAi account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"text\": \"=Analysez ce document de déclaration d'accident du travail ou maladie professionnelle et extrayez toutes les informations structurées.\\n\\nRETOURNEZ UNIQUEMENT un objet JSON valide, sans aucun texte supplémentaire.\\n\\nDéterminez d'abord le type de déclaration :\\n- AT_normale : Déclaration standard d'accident du travail\\n- AT_interim : Déclaration pour un travailleur intérimaire  \\n- maladie_professionnelle : Déclaration de maladie professionnelle\\n\\nExtrayez ensuite toutes les informations disponibles dans le document.\\n\\nTexte du document :\\n{{ $json.extracted_text }}\",\n          \"schemaType\": \"manual\",\n          \"inputSchema\": \"{\\n  \\\"type\\\": \\\"object\\\",\\n  \\\"properties\\\": {\\n    \\\"type_declaration\\\": {\\n      \\\"type\\\": \\\"string\\\",\\n      \\\"enum\\\": [\\\"AT_normale\\\", \\\"AT_interim\\\", \\\"maladie_professionnelle\\\"],\\n      \\\"description\\\": \\\"Type de déclaration identifié\\\"\\n    },\\n    \\\"employeur\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom_raison_sociale\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_postal\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"telephone\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_risque\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"victime\\\": {\\n      \\\"type\\\": \\\"object\\\", \\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"numero_secu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_naissance\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nationalite\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"profession\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"qualification\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_embauche\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"anciennete_poste\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"type_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"accident\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"date\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"heure\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"activite_victime\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_accident\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"objet_contact\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siege_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"horaire_travail\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"consequences\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"arret_travail\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"deces\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"autres_victimes\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"transport_victime\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"temoin\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"tiers\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"implique\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"assurance\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"interim\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"entreprise_travail_temporaire\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"contrat_numero\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    }\\n  },\\n  \\\"required\\\": [\\\"type_declaration\\\", \\\"employeur\\\", \\\"victime\\\", \\\"accident\\\"]\\n}\",\n          \"options\": {}\n        },\n        \"type\": \"@n8n/n8n-nodes-langchain.informationExtractor\",\n        \"typeVersion\": 1.2,\n        \"position\": [\n          -3632,\n          -112\n        ],\n        \"id\": \"710f2dc2-0a48-44c3-9b28-87d435c8e59a\",\n        \"name\": \"GEMINI extraction\",\n        \"continueOnFail\": true\n      },\n      {\n        \"parameters\": {\n          \"text\": \"=Analysez ce document de déclaration d'accident du travail ou maladie professionnelle et extrayez toutes les informations structurées.\\n\\nRETOURNEZ UNIQUEMENT un objet JSON valide, sans aucun texte supplémentaire.\\n\\nDéterminez d'abord le type de déclaration :\\n- AT_normale : Déclaration standard d'accident du travail\\n- AT_interim : Déclaration pour un travailleur intérimaire  \\n- maladie_professionnelle : Déclaration de maladie professionnelle\\n\\nExtrayez ensuite toutes les informations disponibles dans le document.\\n\\nTexte du document :\\n{{ $json.extracted_text }}\",\n          \"schemaType\": \"manual\",\n          \"inputSchema\": \"{\\n  \\\"type\\\": \\\"object\\\",\\n  \\\"properties\\\": {\\n    \\\"type_declaration\\\": {\\n      \\\"type\\\": \\\"string\\\",\\n      \\\"enum\\\": [\\\"AT_normale\\\", \\\"AT_interim\\\", \\\"maladie_professionnelle\\\"],\\n      \\\"description\\\": \\\"Type de déclaration identifié\\\"\\n    },\\n    \\\"employeur\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom_raison_sociale\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_postal\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"telephone\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"code_risque\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"victime\\\": {\\n      \\\"type\\\": \\\"object\\\", \\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"numero_secu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_naissance\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nationalite\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"profession\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"qualification\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_embauche\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"anciennete_poste\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"type_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"accident\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"date\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"heure\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_lieu\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"activite_victime\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_accident\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"objet_contact\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siege_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"nature_lesions\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"horaire_travail\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"consequences\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"arret_travail\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"deces\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"autres_victimes\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"transport_victime\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"temoin\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"prenom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"tiers\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"implique\\\": {\\\"type\\\": \\\"boolean\\\"},\\n        \\\"nom\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"assurance\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    },\\n    \\\"interim\\\": {\\n      \\\"type\\\": \\\"object\\\",\\n      \\\"properties\\\": {\\n        \\\"entreprise_travail_temporaire\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"adresse_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"siret_agence\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"contrat_numero\\\": {\\\"type\\\": \\\"string\\\"},\\n        \\\"date_contrat\\\": {\\\"type\\\": \\\"string\\\"}\\n      }\\n    }\\n  },\\n  \\\"required\\\": [\\\"type_declaration\\\", \\\"employeur\\\", \\\"victime\\\", \\\"accident\\\"]\\n}\",\n          \"options\": {}\n        },\n        \"type\": \"@n8n/n8n-nodes-langchain.informationExtractor\",\n        \"typeVersion\": 1.2,\n        \"position\": [\n          -3632,\n          -384\n        ],\n        \"id\": \"e12304e8-4509-454f-86bc-5df04ccd495b\",\n        \"name\": \"OPENAI Extraction\",\n        \"continueOnFail\": true\n      },\n      {\n        \"parameters\": {\n          \"respondWith\": \"json\",\n          \"responseBody\": \"={{ $json }}\",\n          \"options\": {\n            \"responseHeaders\": {\n              \"entries\": [\n                {\n                  \"name\": \"Access-Control-Allow-Origin\",\n                  \"value\": \"https://accidentdoc-web.vercel.app\"\n                },\n                {\n                  \"name\": \"Access-Control-Allow-Methods\",\n                  \"value\": \"POST, OPTIONS\"\n                },\n                {\n                  \"name\": \"Access-Control-Allow-Headers\",\n                  \"value\": \"Content-Type, X-Requested-With, Authorization\"\n                },\n                {\n                  \"name\": \"Access-Control-Max-Age\",\n                  \"value\": \"600\"\n                },\n                {\n                  \"name\": \"Content-Type\",\n                  \"value\": \"application/json\"\n                }\n              ]\n            }\n          }\n        },\n        \"type\": \"n8n-nodes-base.respondToWebhook\",\n        \"typeVersion\": 1.1,\n        \"position\": [\n          -1248,\n          -32\n        ],\n        \"id\": \"a4cf3e7b-7f5c-4f51-a5ce-e7080f6ca106\",\n        \"name\": \"Respond to Webhook\"\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// CONSTRUCTION DE LA REPONSE FINALE FRONT-READY\\nconst input = $input.first().json;\\nconst responseForWebsite = input.responseForWebsite;\\nconst requestId = input.requestId;\\n\\n// URL de votre site - MISE À JOUR VERCEL\\nconst SITE_URL = 'https://accidentdoc-web.vercel.app';\\n\\n// Construction de la réponse finale front-ready\\nconst finalResponse = {\\n  ok: responseForWebsite.success !== false,\\n  requestId: requestId,\\n  next: responseForWebsite.success !== false ? `${SITE_URL}/validation?rid=${requestId}` : `${SITE_URL}/upload?error=invalid_document`,\\n  payload: responseForWebsite\\n};\\n\\nconsole.log('=== FINAL RESPONSE ===');\\nconsole.log('Request ID:', requestId);\\nconsole.log('Success:', finalResponse.ok);\\nconsole.log('Fallback mode:', responseForWebsite.fallback_mode || false);\\nconsole.log('Document Type:', responseForWebsite.documentType);\\nconsole.log('Session ID:', responseForWebsite.sessionId);\\nif (responseForWebsite.completionStats) {\\n  console.log('Completion Rate:', responseForWebsite.completionStats.completionRate + '%');\\n}\\nif (responseForWebsite.errorDetails) {\\n  console.log('ERROR:', responseForWebsite.errorDetails.message);\\n}\\n\\nreturn finalResponse;\"\n        },\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          -1440,\n          -32\n        ],\n        \"id\": \"2ffaa0d0-9460-4788-952b-108d971fe88a\",\n        \"name\": \"Build Front Response\"\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// PREPARATION DES DONNEES POUR VALIDATION UTILISATEUR (MODE NORMAL)\\nconst finalResult = $input.first().json.resultat_final;\\nconst extractedData = finalResult.declaration;\\nconst sessionId = 'validation_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);\\nconst requestId = $('Init Tracking').first().json.requestId;\\n\\n// Analyser le type de document pour adapter les champs\\nconst docType = extractedData.type;\\nconst isInterim = docType === 'AT_INTERIM';\\nconst isMaladiePro = docType === 'MALADIE_PROFESSIONNELLE';\\n\\n// STRUCTURE DES CHAMPS A VALIDER selon le type\\nlet fieldsToValidate = [];\\n\\n// Champs communs\\nconst commonFields = [\\n  { section: 'employeur', field: 'nom_raison_sociale', label: 'Raison sociale employeur', required: true },\\n  { section: 'employeur', field: 'siret', label: 'SIRET employeur', required: true },\\n  { section: 'employeur', field: 'adresse', label: 'Adresse employeur', required: true },\\n  { section: 'victime', field: 'nom', label: 'Nom de la victime', required: true },\\n  { section: 'victime', field: 'prenom', label: 'Prénom de la victime', required: true },\\n  { section: 'victime', field: 'numero_secu', label: 'Numéro sécurité sociale', required: true },\\n  { section: 'victime', field: 'date_naissance', label: 'Date de naissance', required: true },\\n  { section: 'victime', field: 'adresse', label: 'Adresse de la victime', required: true },\\n  { section: 'victime', field: 'profession', label: 'Profession', required: true }\\n];\\n\\n// Champs spécifiques selon le type\\nif (isMaladiePro) {\\n  fieldsToValidate = commonFields.concat([\\n    { section: 'maladie', field: 'date', label: 'Date des premiers symptômes', required: true },\\n    { section: 'maladie', field: 'lieu', label: 'Lieu d\\\\'exposition', required: false },\\n    { section: 'maladie', field: 'activite_victime', label: 'Activité exposante', required: false }\\n  ]);\\n} else {\\n  fieldsToValidate = commonFields.concat([\\n    { section: 'accident', field: 'date', label: 'Date de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'heure', label: 'Heure de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'lieu', label: 'Lieu de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'activite_victime', label: 'Activité au moment de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'nature_accident', label: 'Nature de l\\\\'accident', required: true },\\n    { section: 'accident', field: 'siege_lesions', label: 'Siège des lésions', required: false },\\n    { section: 'accident', field: 'nature_lesions', label: 'Nature des lésions', required: false }\\n  ]);\\n  \\n  if (isInterim) {\\n    fieldsToValidate = fieldsToValidate.concat([\\n      { section: 'interim', field: 'entreprise_travail_temporaire', label: 'Entreprise de travail temporaire', required: true },\\n      { section: 'interim', field: 'siret_agence', label: 'SIRET de l\\\\'agence', required: true }\\n    ]);\\n  }\\n}\\n\\n// EXTRACTION DES VALEURS ACTUELLES\\nconst currentValues = {};\\nfor (let i = 0; i < fieldsToValidate.length; i++) {\\n  const field = fieldsToValidate[i];\\n  const sectionData = extractedData[field.section] || {};\\n  const value = sectionData[field.field] || null;\\n  \\n  const fieldKey = field.section + '.' + field.field;\\n  currentValues[fieldKey] = {\\n    label: field.label,\\n    value: value,\\n    section: field.section,\\n    field: field.field,\\n    required: field.required,\\n    isEmpty: !value || String(value).trim() === '',\\n    needsValidation: !value || String(value).trim() === '' || field.required\\n  };\\n}\\n\\n// CALCUL DES STATISTIQUES\\nconst totalFields = fieldsToValidate.length;\\nlet filledFields = 0;\\nlet requiredFields = 0;\\nlet filledRequiredFields = 0;\\n\\nfor (const fieldKey in currentValues) {\\n  const field = currentValues[fieldKey];\\n  if (!field.isEmpty) filledFields++;\\n  if (field.required) {\\n    requiredFields++;\\n    if (!field.isEmpty) filledRequiredFields++;\\n  }\\n}\\n\\nconst completionRate = Math.round((filledFields / totalFields) * 100);\\nconst requiredCompletionRate = Math.round((filledRequiredFields / requiredFields) * 100);\\n\\n// Questions contextuelles par défaut\\nconst contextualQuestions = [\\n  {\\n    id: 'commentaire_libre',\\n    question: 'Souhaitez-vous ajouter un commentaire libre avant la génération de la lettre ?',\\n    type: 'textarea',\\n    context: 'Commentaire final',\\n    category: 'cloture'\\n  }\\n];\\n\\n// PREPARATION DE LA REPONSE COMPLETE POUR LE SITE WEB\\nconst responseForWebsite = {\\n  success: true,\\n  fallback_mode: false,\\n  sessionId: sessionId,\\n  documentType: docType,\\n  \\n  extractedData: {\\n    employeur: extractedData.employeur || {},\\n    victime: extractedData.victime || {},\\n    accident: isMaladiePro ? null : (extractedData.accident || {}),\\n    maladie: isMaladiePro ? (extractedData.maladie || {}) : null,\\n    interim: isInterim ? (extractedData.interim || {}) : null,\\n    temoin: extractedData.temoin || {},\\n    tiers: extractedData.tiers || {}\\n  },\\n  \\n  validationFields: currentValues,\\n  contextualQuestions: contextualQuestions,\\n  \\n  completionStats: {\\n    totalFields: totalFields,\\n    filledFields: filledFields,\\n    completionRate: completionRate,\\n    requiredFields: requiredFields,\\n    filledRequiredFields: filledRequiredFields,\\n    requiredCompletionRate: requiredCompletionRate\\n  },\\n  \\n  nextStep: 'user_validation',\\n  instructions: {\\n    message: 'Vérifiez et complétez les informations extraites automatiquement.',\\n    validationEndpoint: '/webhook/validate-data',\\n    expectedFields: fieldsToValidate.map(f => f.section + '.' + f.field)\\n  },\\n  \\n  metadata: {\\n    extractionSource: 'mistral_ocr',\\n    aiModel: finalResult.metadata.ai_model || 'gemini-2.0-flash',\\n    extractionTimestamp: finalResult.timestamp,\\n    validationPreparedAt: new Date().toISOString()\\n  }\\n};\\n\\nreturn {\\n  responseForWebsite: responseForWebsite,\\n  requestId: requestId\\n};\"\n        },\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          -1664,\n          -144\n        ],\n        \"id\": \"27bfe0bf-1337-48ec-ad85-d0ad46dc9357\",\n        \"name\": \"Prepare User Validation\"\n      },\n      {\n        \"parameters\": {\n          \"assignments\": {\n            \"assignments\": [\n              {\n                \"id\": \"final-result\",\n                \"name\": \"resultat_final\",\n                \"type\": \"object\",\n                \"value\": \"={{ {\\n  success: true,\\n  timestamp: new Date().toISOString(),\\n  declaration: $json.declaration_formatee,\\n  metadata: {\\n    source: 'mistral_ocr',\\n    ai_model: 'gemini-2.0-flash',\\n    extraction_time: new Date().toISOString()\\n  }\\n} }}\"\n              }\n            ]\n          },\n          \"options\": {}\n        },\n        \"type\": \"n8n-nodes-base.set\",\n        \"typeVersion\": 3.4,\n        \"position\": [\n          -1824,\n          -144\n        ],\n        \"id\": \"baab3f06-7bf8-4eb5-8ac1-aa87362ee8b4\",\n        \"name\": \"Final Result\"\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// GESTION ERREUR - DOCUMENT NON CONFORME\\nconst requestId = $('Init Tracking').first().json.requestId;\\nconst sessionId = 'invalid_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);\\n\\n// Récupérer le type détecté (s'il existe)\\nconst detectedType = $input.first().json.output?.type_declaration || 'UNKNOWN';\\n\\n// Message d'erreur détaillé\\nconst errorMessage = `Le document uploadé ne correspond pas à un type de déclaration attendu.\\\\n\\\\nType détecté: ${detectedType}\\\\n\\\\nTypes acceptés:\\\\n- AT_normale (Déclaration d'accident du travail standard)\\\\n- AT_interim (Déclaration d'accident du travail pour intérimaire)\\\\n- maladie_professionnelle (Déclaration de maladie professionnelle)\\\\n\\\\nVeuillez vérifier que vous avez uploadé le bon document.`;\\n\\nconst invalidDocResponse = {\\n  success: false,\\n  error_type: 'INVALID_DOCUMENT_TYPE',\\n  fallback_mode: false,\\n  sessionId: sessionId,\\n  documentType: detectedType,\\n  \\n  errorDetails: {\\n    code: 'DOC_TYPE_MISMATCH',\\n    message: errorMessage,\\n    detectedType: detectedType,\\n    expectedTypes: ['AT_normale', 'AT_interim', 'maladie_professionnelle'],\\n    suggestion: 'Veuillez uploader une déclaration d\\\\'accident du travail (intérim ou normale) ou une déclaration de maladie professionnelle.'\\n  },\\n  \\n  nextStep: 'upload_correct_document',\\n  instructions: {\\n    message: 'Document non conforme. Veuillez uploader un document de type attendu.',\\n    uploadEndpoint: '/webhook/upload',\\n    acceptedDocumentTypes: [\\n      'Déclaration d\\\\'accident du travail (CERFA 14463)',\\n      'Déclaration d\\\\'accident du travail intérim (CERFA 14463)',\\n      'Déclaration de maladie professionnelle (CERFA 60-3950)'\\n    ]\\n  },\\n  \\n  metadata: {\\n    extractionSource: 'mistral_ocr',\\n    aiModel: 'ai_detection',\\n    extractionTimestamp: new Date().toISOString(),\\n    error_reason: 'Document type not matching expected types',\\n    elapsed_time: Date.now() - $('Init Tracking').first().json.startTime\\n  }\\n};\\n\\nreturn {\\n  responseForWebsite: invalidDocResponse,\\n  requestId: requestId\\n};\"\n        },\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          -2288,\n          176\n        ],\n        \"id\": \"56420ed5-3029-4cc4-80df-c120d47e5d0e\",\n        \"name\": \"Build Invalid Document Error\"\n      },\n      {\n        \"parameters\": {\n          \"assignments\": {\n            \"assignments\": [\n              {\n                \"id\": \"format-mp\",\n                \"name\": \"declaration_formatee\",\n                \"type\": \"object\",\n                \"value\": \"={{ {\\n  type: 'MALADIE_PROFESSIONNELLE',\\n  numero_declaration: 'MP' + new Date().getTime(),\\n  date_extraction: new Date().toISOString(),\\n  employeur: $json.output.employeur,\\n  victime: $json.output.victime,\\n  maladie: $json.output.accident,\\n  temoin: $json.output.temoin,\\n  statut: 'EXTRACTED'\\n} }}\"\n              }\n            ]\n          },\n          \"options\": {}\n        },\n        \"type\": \"n8n-nodes-base.set\",\n        \"typeVersion\": 3.4,\n        \"position\": [\n          -2080,\n          -144\n        ],\n        \"id\": \"28b24ac1-fa66-4131-b4e3-e0159c8e20b8\",\n        \"name\": \"Format Maladie Pro\"\n      },\n      {\n        \"parameters\": {\n          \"assignments\": {\n            \"assignments\": [\n              {\n                \"id\": \"format-at-interim\",\n                \"name\": \"declaration_formatee\",\n                \"type\": \"object\",\n                \"value\": \"={{ {\\n  type: 'AT_INTERIM',\\n  numero_declaration: 'ATI' + new Date().getTime(),\\n  date_extraction: new Date().toISOString(),\\n  employeur: $json.output.employeur,\\n  victime: $json.output.victime,\\n  accident: $json.output.accident,\\n  interim: $json.output.interim,\\n  temoin: $json.output.temoin,\\n  tiers: $json.output.tiers,\\n  statut: 'EXTRACTED'\\n} }}\"\n              }\n            ]\n          },\n          \"options\": {}\n        },\n        \"type\": \"n8n-nodes-base.set\",\n        \"typeVersion\": 3.4,\n        \"position\": [\n          -2080,\n          -496\n        ],\n        \"id\": \"7ebb36d7-57d2-40b5-98e9-f25c798fd55d\",\n        \"name\": \"Format AT Intérim\"\n      },\n      {\n        \"parameters\": {\n          \"assignments\": {\n            \"assignments\": [\n              {\n                \"id\": \"format-at-normale\",\n                \"name\": \"declaration_formatee\",\n                \"type\": \"object\",\n                \"value\": \"={{ {\\n  type: 'AT_NORMALE',\\n  numero_declaration: 'AT' + new Date().getTime(),\\n  date_extraction: new Date().toISOString(),\\n  employeur: $json.output.employeur,\\n  victime: $json.output.victime,\\n  accident: $json.output.accident,\\n  temoin: $json.output.temoin,\\n  tiers: $json.output.tiers,\\n  statut: 'EXTRACTED'\\n} }}\"\n              }\n            ]\n          },\n          \"options\": {}\n        },\n        \"type\": \"n8n-nodes-base.set\",\n        \"typeVersion\": 3.4,\n        \"position\": [\n          -2080,\n          -320\n        ],\n        \"id\": \"188bdc68-19ef-463a-bd1d-fabb6faacf96\",\n        \"name\": \"Format AT Normale\"\n      },\n      {\n        \"parameters\": {\n          \"rules\": {\n            \"values\": [\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"caseSensitive\": true,\n                    \"leftValue\": \"\",\n                    \"typeValidation\": \"strict\",\n                    \"version\": 2\n                  },\n                  \"conditions\": [\n                    {\n                      \"leftValue\": \"={{ $json.output.type_declaration }}\",\n                      \"rightValue\": \"AT_interim\",\n                      \"operator\": {\n                        \"type\": \"string\",\n                        \"operation\": \"equals\"\n                      },\n                      \"id\": \"838ae07e-b6c5-4158-a1bb-2f6608f16985\"\n                    }\n                  ],\n                  \"combinator\": \"and\"\n                }\n              },\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"caseSensitive\": true,\n                    \"leftValue\": \"\",\n                    \"typeValidation\": \"strict\",\n                    \"version\": 2\n                  },\n                  \"conditions\": [\n                    {\n                      \"id\": \"c1463ff9-09fe-4a2f-9223-25b516ebbf2b\",\n                      \"leftValue\": \"={{ $json.output.type_declaration }}\",\n                      \"rightValue\": \"AT_normale\",\n                      \"operator\": {\n                        \"type\": \"string\",\n                        \"operation\": \"equals\",\n                        \"name\": \"filter.operator.equals\"\n                      }\n                    }\n                  ],\n                  \"combinator\": \"and\"\n                }\n              },\n              {\n                \"conditions\": {\n                  \"options\": {\n                    \"caseSensitive\": true,\n                    \"leftValue\": \"\",\n                    \"typeValidation\": \"strict\",\n                    \"version\": 2\n                  },\n                  \"conditions\": [\n                    {\n                      \"id\": \"bd1d2084-5ffc-444c-a108-87329fbf4fb9\",\n                      \"leftValue\": \"={{ $json.output.type_declaration }}\",\n                      \"rightValue\": \"maladie_professionnelle\",\n                      \"operator\": {\n                        \"type\": \"string\",\n                        \"operation\": \"equals\",\n                        \"name\": \"filter.operator.equals\"\n                      }\n                    }\n                  ],\n                  \"combinator\": \"and\"\n                }\n              }\n            ]\n          },\n          \"options\": {\n            \"fallbackOutput\": \"extra\"\n          }\n        },\n        \"type\": \"n8n-nodes-base.switch\",\n        \"typeVersion\": 3.2,\n        \"position\": [\n          -2656,\n          -256\n        ],\n        \"id\": \"c51ab7e3-c335-4107-b4c6-effd9f1a13e0\",\n        \"name\": \"Route by Type\"\n      },\n      {\n        \"parameters\": {\n          \"modelName\": \"models/gemini-2.0-flash-exp\",\n          \"options\": {}\n        },\n        \"type\": \"@n8n/n8n-nodes-langchain.lmChatGoogleGemini\",\n        \"typeVersion\": 1,\n        \"position\": [\n          -3552,\n          64\n        ],\n        \"id\": \"4523eb8c-6faf-41cc-95bf-fec1f911eb78\",\n        \"name\": \"Gemini 2.0 Flash\",\n        \"credentials\": {\n          \"googlePalmApi\": {\n            \"id\": \"uPkthesEOgAOyuUB\",\n            \"name\": \"Google Gemini(PaLM) Api account\"\n          }\n        }\n      },\n      {\n        \"parameters\": {\n          \"assignments\": {\n            \"assignments\": [\n              {\n                \"id\": \"text_content\",\n                \"name\": \"extracted_text\",\n                \"type\": \"string\",\n                \"value\": \"={{ $json.pages?.map(page => page.markdown).join('\\\\n\\\\n') || '' }}\"\n              },\n              {\n                \"id\": \"ocr_success\",\n                \"name\": \"ocr_success\",\n                \"type\": \"boolean\",\n                \"value\": \"={{ $json.pages && $json.pages.length > 0 }}\"\n              }\n            ]\n          },\n          \"options\": {}\n        },\n        \"type\": \"n8n-nodes-base.set\",\n        \"typeVersion\": 3.4,\n        \"position\": [\n          -4032,\n          128\n        ],\n        \"id\": \"2b83eef2-de70-408a-aae8-940b9ae3f0a9\",\n        \"name\": \"Format Text\"\n      },\n      {\n        \"parameters\": {\n          \"method\": \"POST\",\n          \"url\": \"https://api.mistral.ai/v1/ocr\",\n          \"authentication\": \"genericCredentialType\",\n          \"genericAuthType\": \"httpHeaderAuth\",\n          \"sendBody\": true,\n          \"specifyBody\": \"json\",\n          \"jsonBody\": \"={{ JSON.stringify({\\n  \\\"model\\\": \\\"mistral-ocr-latest\\\",\\n  \\\"document\\\": {\\n    \\\"type\\\": \\\"document_url\\\",\\n    \\\"document_url\\\": $json.url\\n  },\\n  \\\"include_image_base64\\\": false\\n}) }}\",\n          \"options\": {\n            \"timeout\": 25000\n          }\n        },\n        \"type\": \"n8n-nodes-base.httpRequest\",\n        \"typeVersion\": 4.2,\n        \"position\": [\n          -4192,\n          128\n        ],\n        \"id\": \"1893012c-2506-4ec0-83b3-879a2c86400a\",\n        \"name\": \"Extract OCR\",\n        \"credentials\": {\n          \"httpHeaderAuth\": {\n            \"id\": \"ky1L3tKefy3aLQey\",\n            \"name\": \"Mistral OCR\"\n          }\n        },\n        \"continueOnFail\": true\n      },\n      {\n        \"parameters\": {\n          \"url\": \"=https://api.mistral.ai/v1/files/{{ $json.id }}/url\",\n          \"authentication\": \"genericCredentialType\",\n          \"genericAuthType\": \"httpHeaderAuth\",\n          \"sendQuery\": true,\n          \"queryParameters\": {\n            \"parameters\": [\n              {\n                \"name\": \"expiry\",\n                \"value\": \"24\"\n              }\n            ]\n          },\n          \"options\": {\n            \"timeout\": 15000\n          }\n        },\n        \"type\": \"n8n-nodes-base.httpRequest\",\n        \"typeVersion\": 4.2,\n        \"position\": [\n          -4400,\n          128\n        ],\n        \"id\": \"09d58179-eccf-4efb-a18d-5a67fabaebae\",\n        \"name\": \"Get Signed URL\",\n        \"credentials\": {\n          \"httpHeaderAuth\": {\n            \"id\": \"ky1L3tKefy3aLQey\",\n            \"name\": \"Mistral OCR\"\n          }\n        },\n        \"continueOnFail\": true\n      },\n      {\n        \"parameters\": {\n          \"respondWith\": \"noData\",\n          \"options\": {\n            \"responseHeaders\": {\n              \"entries\": [\n                {\n                  \"name\": \"Access-Control-Allow-Origin\",\n                  \"value\": \"https://accidentdoc-web.vercel.app\"\n                },\n                {\n                  \"name\": \"Access-Control-Allow-Methods\",\n                  \"value\": \"POST, OPTIONS\"\n                },\n                {\n                  \"name\": \"Access-Control-Allow-Headers\",\n                  \"value\": \"Content-Type, X-Requested-With, Authorization\"\n                },\n                {\n                  \"name\": \"Access-Control-Max-Age\",\n                  \"value\": \"600\"\n                }\n              ]\n            }\n          }\n        },\n        \"type\": \"n8n-nodes-base.respondToWebhook\",\n        \"typeVersion\": 1.1,\n        \"position\": [\n          -4736,\n          448\n        ],\n        \"id\": \"474115bd-f1fe-4bc4-b666-d9e4b384d2cb\",\n        \"name\": \"Respond OPTIONS\"\n      },\n      {\n        \"parameters\": {\n          \"httpMethod\": \"OPTIONS\",\n          \"path\": \"upload\",\n          \"responseMode\": \"responseNode\",\n          \"options\": {\n            \"rawBody\": false\n          }\n        },\n        \"type\": \"n8n-nodes-base.webhook\",\n        \"typeVersion\": 2,\n        \"position\": [\n          -4944,\n          448\n        ],\n        \"id\": \"51f3ad1c-bb9f-4220-9de4-40b82348d3d3\",\n        \"name\": \"OPTIONS Preflight\",\n        \"webhookId\": \"options-preflight\"\n      },\n      {\n        \"parameters\": {\n          \"httpMethod\": \"POST\",\n          \"path\": \"upload\",\n          \"responseMode\": \"responseNode\",\n          \"options\": {\n            \"rawBody\": false\n          }\n        },\n        \"type\": \"n8n-nodes-base.webhook\",\n        \"typeVersion\": 2,\n        \"position\": [\n          -4992,\n          288\n        ],\n        \"id\": \"fb60b218-a2b7-4746-8982-99c1a89ea9cd\",\n        \"name\": \"Upload Webhook\",\n        \"webhookId\": \"upload-webhook\"\n      },\n      {\n        \"parameters\": {\n          \"jsCode\": \"// Init tracking - CONSERVE LES DONNEES BINAIRES\\nconst items = $input.all();\\n\\nfor (const item of items) {\\n  item.json.requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\\n  item.json.startTime = Date.now();\\n}\\n\\nreturn items;\"\n        },\n        \"type\": \"n8n-nodes-base.code\",\n        \"typeVersion\": 2,\n        \"position\": [\n          -4784,\n          288\n        ],\n        \"id\": \"559ede3b-7977-45a1-8328-058db2c5d41d\",\n        \"name\": \"Init Tracking\"\n      },\n      {\n        \"parameters\": {\n          \"method\": \"POST\",\n          \"url\": \"https://api.mistral.ai/v1/files\",\n          \"authentication\": \"genericCredentialType\",\n          \"genericAuthType\": \"httpHeaderAuth\",\n          \"sendBody\": true,\n          \"contentType\": \"multipart-form-data\",\n          \"bodyParameters\": {\n            \"parameters\": [\n              {\n                \"name\": \"purpose\",\n                \"value\": \"ocr\"\n              },\n              {\n                \"parameterType\": \"formBinaryData\",\n                \"name\": \"file\",\n                \"inputDataFieldName\": \"file\"\n              }\n            ]\n          },\n          \"options\": {\n            \"timeout\": 30000\n          }\n        },\n        \"type\": \"n8n-nodes-base.httpRequest\",\n        \"typeVersion\": 4.3,\n        \"position\": [\n          -4592,\n          288\n        ],\n        \"id\": \"9af853c8-ab5b-4304-946e-e50211283927\",\n        \"name\": \"Upload to Mistral\",\n        \"credentials\": {\n          \"httpHeaderAuth\": {\n            \"id\": \"ky1L3tKefy3aLQey\",\n            \"name\": \"Mistral OCR\"\n          }\n        },\n        \"onError\": \"continueRegularOutput\"\n      }\n    ],\n    \"connections\": {\n      \"Merge\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"AI competition\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"GEMINI extraction\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Merge\",\n              \"type\": \"main\",\n              \"index\": 1\n            }\n          ]\n        ]\n      },\n      \"OPENAI Extraction\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Merge\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"OpenAI Chat Model\": {\n        \"ai_languageModel\": [\n          [\n            {\n              \"node\": \"OPENAI Extraction\",\n              \"type\": \"ai_languageModel\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"AI competition\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Route by Type\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Build Front Response\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Respond to Webhook\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Prepare User Validation\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Build Front Response\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Final Result\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Prepare User Validation\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Build Invalid Document Error\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Build Front Response\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Format Maladie Pro\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Final Result\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Format AT Intérim\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Final Result\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Format AT Normale\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Final Result\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Route by Type\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Format AT Intérim\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ],\n          [\n            {\n              \"node\": \"Format AT Normale\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ],\n          [\n            {\n              \"node\": \"Format Maladie Pro\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ],\n          [\n            {\n              \"node\": \"Build Invalid Document Error\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Gemini 2.0 Flash\": {\n        \"ai_languageModel\": [\n          [\n            {\n              \"node\": \"GEMINI extraction\",\n              \"type\": \"ai_languageModel\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Format Text\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"GEMINI extraction\",\n              \"type\": \"main\",\n              \"index\": 0\n            },\n            {\n              \"node\": \"OPENAI Extraction\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Extract OCR\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Format Text\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Get Signed URL\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Extract OCR\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"OPTIONS Preflight\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Respond OPTIONS\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Upload Webhook\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Init Tracking\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Init Tracking\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Upload to Mistral\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      },\n      \"Upload to Mistral\": {\n        \"main\": [\n          [\n            {\n              \"node\": \"Get Signed URL\",\n              \"type\": \"main\",\n              \"index\": 0\n            }\n          ]\n        ]\n      }\n    },\n    \"authors\": \"franck franck.lapuyade@atexya.com\",\n    \"name\": \"Version 20cb7d69\",\n    \"description\": \"\",\n    \"autosaved\": false,\n    \"workflowPublishHistory\": [\n      {\n        \"createdAt\": \"2026-01-16T15:04:49.212Z\",\n        \"id\": 54,\n        \"workflowId\": \"nVssYwN1ZQp0nw97\",\n        \"versionId\": \"20cb7d69-f323-4087-b191-d90b06dee301\",\n        \"event\": \"activated\",\n        \"userId\": \"d0bd9d76-afaf-4157-8f6c-638ab4b0b11f\"\n      }\n    ]\n  }\n}"
  }
]